{% extends 'base.html' %}
{% block content %}
<h1>Панель администратора</h1>
    
<form method="get">
    <label>Фильтр:</label>
    <select name="status" onchange="this.form.submit()">
        <option value="">Все</option>
        <option value="new" {% if status_filter == 'new' %}selected{% endif %}>Новые</option>
        <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>Принято в работу</option>
        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Выполнено</option>
    </select>
</form>
    
<h2>Заявки</h2>
{% for app in applications %}
    <div style="border:1px solid #ccc; padding:10px; margin:10px 0;">
        <strong>{{ app.title }}</strong> ({{ app.created_at|date:"d.m.Y H:i" }})<br>
        Пользователь: {{ app.user.first_name|default:app.user.username }}<br>
        Категория: {{ app.category }}<br>
        Статус: {{ app.get_status_display }}<br>
        Описание: {{ app.description|truncatewords:10 }}
        {% if app.status == 'new' %}
            <form method="post" action="{% url 'update_application_status' app.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="radio" name="status" value="in_progress" required> Принято в работу
                <input type="text" name="admin_comment" placeholder="Комментарий" required>
                <br>
                <input type="radio" name="status" value="completed"> Выполнено
                <input type="file" name="design_image" accept=".jpg,.jpeg,.png,.bmp">
                <br>
                <button type="submit">Обновить статус</button>
            </form>
        {% elif app.status == 'in_progress' %}
            <p>Комментарий: {{ app.admin_comment }}</p>
        {% elif app.status == 'completed' %}
            {% if app.design_image %}
                <img src="{{ app.design_image.url }}" width="200">
            {% endif %}
        {% endif %}
    </div>
{% empty %}
    <p>Заявок нет.</p>
{% endfor %}
    
<h2>Управление категориями</h2>
<form method="post" action="{% url 'manage_categories' %}">
    {% csrf_token %}
    <input type="hidden" name="action" value="add">
    <input type="text" name="name" placeholder="Новая категория" required>
    <button type="submit">Добавить</button>
</form>

<ul>
{% for cat in categories %}
    <li>
        {{ cat.name }}
        <form method="post" action="{% url 'manage_categories' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="category_id" value="{{ cat.id }}">
            <button type="submit" onclick="return confirm('Удалить категорию и все её заявки?')">Удалить</button>
        </form>
    </li>
{% endfor %}
</ul>

<a href="{% url 'logout' %}">Выход</a>
{% endblock %}